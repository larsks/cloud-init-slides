<!DOCTYPE html>

<!--
  This slideshow is written using Remark
  (https://github.com/gnab/remark).
-->

<html>
  <head>
    <title>Introduction to cloud-init</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <link rel="stylesheet" href="slides.css"></link>
  </head>
  <body>
    <textarea id="source">

class: center, middle
# Introduction to cloud-init

- Steve Hardy (shardy@redhat.com)
- Lars Kellogg-Stedman (lars@redhat.com)

---

## What is cloud-init?

- Provides first-boot customization for cloud instances
  using metadata from your cloud platform
- Standardized YAML syntax for common operations
- Create users, install packages, etc
- Modular and highly configurable

---

## Integration

- Can be used to bootstrap other CM tools or agents
- Widely used and broadly supported solution
  - OpenStack
  - EC2
  - RHEV
  - (vSphere, OpenNebula, MAAS, CloudStack, OVF)

---

## Availability

- Standard solution in cloud images from many distributions
  - [Fedora][]
  - [Ubuntu][]
- You may already be using it
  - Provisions ssh keys
  - Grows root filesystem
  - Sets system hostname

[fedora]: http://fedoraproject.org/en/get-fedora-options#clouds
[ubuntu]: http://cloud-images.ubuntu.com/

---

## Data sources

Cloud-init supports several metadata sources:

- EC2 metadata (EC2 and OpenStack Nova)
- Config Drive 
- AltCloud (RHEVm, vSphere)
- NoCloud
- OpenNebula
- Fallback/None

---

## OpenStack/EC2 data source

- Access metadata service at http://169.254.169.254.
- NAT rules on your network controller make this work
- Service provided by `neutron-metadata-agent` (via per-router
  `neutron-metadata-proxy`) or `nova-api-metadata`

---

## OpenStack/EC2 data source

.medium[

    $ curl http://169.254.169.254/latest/meta-data
    ami-id
    ami-launch-index
    ami-manifest-path
    block-device-mapping/
    hostname
    instance-action
    instance-id
    instance-type
    kernel-id
    local-hostname
    local-ipv4
    placement/
    public-hostname
    public-ipv4
    public-keys/
    ramdisk-id
    reservation-id
]

---

## Meta-data and user-data

- `meta-data` is provided by cloud platform
- `user-data` is a chunk of arbitrary data that you provide

---

## User-data content

- Either plain text or MIME Multi-part archive
- Optionally gzip compressed 
- Retrieved from DataSource to `/var/lib/cloud`

---
## User-data content

Many supported content types:

- cloud-config (`#cloud-config`)

    YAML configuration file for performing many common configuration
    actions.

- cloud-boothook (`#cloud-boothook`)

    Saved to a file and executed early in the boot process.

---
## User-data content

- include files (`#include`)

    A list of URLs, one per line. Cloud-init fetches content from each
    URL and handles it appropriately.

- arbitrary scripts (`#!`)

    Run code with arbitrary interpreters.

---

## User-data content

- MIME multipart archive

    Package multiple user-data formats into a single MIME multipart
    archive.

- part-handler (`#part-handler`)

    Handler for custom content types in a MIME archive.

[Complete documentation][format]

[format]: http://cloudinit.readthedocs.org/en/latest/topics/format.html

---

## Example user-data: scripts

Run a script when the system first boots:

    #!/bin/sh
    yum -d1 -y install git screen vim-enhanced

Doesn't have to be a `/bin/sh` script:

    #!/usr/bin/python
    import os
    os.system('yum -d1 -y install ' +
        'git screen vim-enhanced'.split())

???

Put this in a file and provide it to `nova boot --user-data=...`, or
put it in the *Customization Script* field of the *Post-creating* tab
when booting an instance in Horizon.

---

## Example user-data: cloud-config

    #cloud-config
    package_upgrade: true
    packages:
    - git
    - screen
    - vim-enhanced

???

This will upgrade all your packages and make sure that `git`,
`screen`, and `vim-enhanced` are all installed.

---

## Example user-data: include

    #include
    http://config.example.com/cloud-config
    http://config.dept.example.com/cloud-config


???

An `#include` file is a list of URLs, one per line.  Each URL will be
fetched and then processed according to the same rules as the
`user-data` file.

---

## Example user-data: MIME archive


.small[
```
From nobody Thu Dec  5 13:49:30 2013
Content-Type: multipart/mixed; boundary="===============0281124342848062795=="
MIME-Version: 1.0

--===============0281124342848062795==
MIME-Version: 1.0
Content-Type: text/x-shellscript; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.1"

#!/bin/sh

touch /root/flagfile


--===============0281124342848062795==
MIME-Version: 1.0
Content-Type: text/cloud-config; charset="us-ascii"
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="userdata.2"

packages:
- vim-enhanced
- git
- screen

--===============0281124342848062795==--
```
]

---

## Custom part handlers

.medium[

    def handle_part(data, ctype,
        filename, payload):
        # data = the cloudinit object
        # ctype = "__begin__", "__end__", or the
        # mime-type of the part that is being handled.
        # filename = the filename of the part (or
        #   a generated filename if none is 
        #   present in mime data)
        # payload = the parts' content

    def list_types():
      return ['text/x-myapp-configdata']
]

---

## Cloud-config

Cloud-config is a simple YAML DSL for expressing system configuration
tasks:

- Disk configuration
- Execute arbitrary commands
- Create users and groups
- Package management
- Create files
- Bootstrap Chef/Puppet

---

## Cloud-config

- `user-data` processed by modules
  (`.../site-packages/cloud-init/config/cc_*`)
- `cloud_init_modules` and `cloud_config_modules` determine which
  modules are run when
- merges configurations from multiple sources

---

## Cloud-config

For example, if `/etc/cloud/cloud.cfg` does not include
`package-update-upgrade-install` module (package management):

    #cloud-config
    cloud_config_modules:
      - package-update-upgrade-install
    package_upgrade: true
    packages:
      - git
      - screen
      - vim-enhanced

---

## Cloud-config

- Lots of [examples][] in the [documentation][]
- Modules are a little under-documented
- Use the source (Luke)

[examples]: http://cloudinit.readthedocs.org/en/latest/topics/examples.html
[documentation]: http://cloudinit.readthedocs.org/

---

## Heat and cloud-init

- Heat injects information into instances via cloud-init
- Default mechanism relies on custom `part-handler` 
- You can also specify arbitrary `user-data` content in your
  templates.

---

## Heat with arbitrary user-data

    resources:
      instance0:
        type: OS::Nova::Server
        properties:
          user_data_format: RAW
          user_data: |
            #cloud-config
            packages:
              - vim
              - screen
              - git

---

class: center, middle

# Questions?

- Slides sources at http://github.com/larsks/cloud-init-slides
- Steve Hardy (shardy@redhat.com)
- Lars Kellogg-Stedman (lars@redhat.com)


    </textarea>
    <script src="remark.js" type="text/javascript"></script>
    <script type="text/javascript">
      var slideshow = remark.create();
    </script>
  </body>
</html>

<!-- vim: set ft=markdown : -->

